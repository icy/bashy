#!/usr/bin/env bash

# Date    : 2019-09-06
# Author  : Ky-Anh Huynh
# Purpose : wrapper for all k8s commands/clusters

# Ideas
#
#   1. Hook up $HOME variable
#   2. Explicitly avoid kind of human mistakes when dealing with
#       multiple clusters and namespaces
#   3. To use with/by non-human scripts ;)
#
# Usage
#
# 1. Initialize clusters' root
#
#   $ mkdir ~/projects/gk8s/<cluster-name>
#   $ cd ~/projects/gk8s/<cluster-name>
#   $ touch .k8s
#
# 2. Provision aws configurations
#
#   $ ln -s ~/.aws .aws
#
# 3. Provision k8s configurations
#
#   $ ln -s ~/.kube .kube
#
#   Specify the default namespace. Default to `default` ;)
#
#   $ echo my-default-namespace > .k8s
#
# 4. Optionally create an shortcut
#
#   $ ln -s ~/projects/gk8s/<cluster-name> ~/bin/gk8s-<cluster-name>
#
# 5. Invoke the command
#
#   $ gk8s get pods      # on the default namespace,
#                        # on namespace specified in `.k8s`
#   $ gk8s get pods @%   # on all namespaces
#
#   You can move around and execute your alias command instead
#
#   $ cd /my/parent/home
#   $ gk8s-<cluster-name> get pods
#
#
#  `kubectl` is injected when you are not specifed them as your first
#  argument. E.g, `gk8s get pods` is the same as `gk8s kubectl get pods`.
#

_basename="${0##*/}"
case "$_basename" in
"gk8s" )
  _CLUSTER="$(pwd)"
  _CLUSTER="${_CLUSTER##*/}"
  ;;

"gk8s-"*)
  _CLUSTER="${_basename#*-}"
  cd "$HOME/projects/gk8s/$_CLUSTER" || exit
  ;;
esac

if [[ ! -f ".k8s" ]]; then
  echo >&2 "... Missing .k8s file. Giving up."
  exit 1
fi

_help() {
  echo >&2 ":: Please specify a command."
}

if [[ "$#" -eq 0 ]]; then
  set -- _help
fi

# Getting namespace from the file .k8s
_ns="$(head -1 .k8s)"
if [[ -z "$_ns" ]]; then
  _ns="--namespace default"
else
  _ns="--namespace $_ns"
fi

case "${1:-}" in
"kubectl"*|"helm"*|_help)
  ;;
*)
  set -- kubectl "$@"
  ;;
esac

# Insert the namespace configuration...
_cmd1="$1";
case "$_cmd1" in
kubectl.*)

  shift;
  _cmd2="$1"; shift;
  set -- "$_cmd1" "$_cmd2" $_ns "$@"
  ;;
esac

_oargs=( "$@" )
_start=0
while [[ "$_start" -le "${#_oargs}" ]]; do
  if [[ "${_oargs[$_start]}" == "@%" ]]; then
    _oargs["$_start"]="--all-namespaces"
  fi
  (( _start ++ ))
done

set -- "${_oargs[@]}"
export OHOME="$HOME"
export HOME="$(pwd)"

# Print heading...
echo >&2 ":: Cluster: $_CLUSTER, input namespace: $_ns"
echo >&2 ":: WDir: $(pwd)"
echo >&2 ":: Command: $@"
echo >&2 ":: OHOME: $OHOME"
echo >&2 ":: NHOME: $HOME"

"${@}"
